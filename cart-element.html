<link rel="import" href="bower_components/polymer/polymer.html">
<link rel="import" href="bower_components/paper-item/paper-item.html">
<link rel="import" href="bower_components/paper-item/paper-item-body.html">
<link rel="import" href="bower_components/paper-material/paper-material.html">
<link rel="import" href="bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="bower_components/paper-header-panel/paper-header-panel.html">

<dom-module id="cart-element">
    <style is="custom-style">
        .content{
            border: solid 1px #f6f6f6;
        }

        .orderTicket {
            margin: 5px 0px 5px 0px;
        }
        .menu{
            margin-top: 5px;
            background-color: #008fcd;
            text-align: center;
        }
        .menu a {
            color: white;
        }
    </style>
    <template>
        <iron-signals on-iron-signal-add-order="addOrder"></iron-signals>
        <iron-signals on-iron-signal-reset-cart="resetCart"></iron-signals>
        <template is="dom-if" if="{{orders}}">
            <ul class="menu expanded">
                <li><a on-click="sort" href="#"><iron-icon icon="arrow-downward"></iron-icon></a></li>
                <li><a href="#"><iron-icon icon="arrow-upward"></iron-icon></a></li>
                <li><a on-click="filterNotFree" href="#"><iron-icon icon="shopping-cart"></iron-icon></a></li>
                <li><a on-click="filterFree" href="#"><iron-icon icon="mail"></iron-icon></a></li>
                <li><a on-click="filterReset" href="#"><iron-icon icon="cached"></iron-icon></a></li>
            </ul>
        </template>
        <template is="dom-repeat" items="{{orders}}" filter="{{computeFilter(searchString)}}" sort="sort" >
            <paper-material class="orderTicket" elevation="1">
                <paper-item>
                    <iron-icon icon="{{item.icon}}"></iron-icon>
                    <paper-item-body two-line>
                        <div>{{item.title}}</div>
                        <div secondary>{{item.price}} €</div>
                    </paper-item-body>
                    <iron-icon icon="close"></iron-icon>
                    <paper-item-body>
                        <div>{{item.ordered}}</div>
                    </paper-item-body>
                    <paper-item-body>
                        <div>{{item.priceTotal}} €</div>
                    </paper-item-body>
                    <paper-item-body>
                        <paper-button>
                            <iron-icon on-click="add" icon="add"></iron-icon>
                        </paper-button>
                        <paper-button>
                            <iron-icon on-click="remove" icon="remove"></iron-icon>
                        </paper-button>
                    </paper-item-body>
                </paper-item>
            </paper-material>
        </template>

    </template>

    <script>
        Polymer({
            is: 'cart-element',
            ready: function () {
                this.sumOrder = '0',
                        this.orders = [],
                        this.searchString = null
            },
            listeners: {
                'addOrder': 'addOrder',
                'resetCart': 'resetCart',
            },
            sort: function(){
                return this.orders.sort(function(a, b){
                        var priceTotalA = a.priceTotal, priceTotalB = b.priceTotal;
                        if(priceTotalA == priceTotalB) return 0;
                       return (priceTotalA > priceTotalB)?1:-1;

                    });
            },
            filterNotFree: function(){
                this.searchString = 'notFree'
            },
            filterFree: function(){
                this.searchString = 'free'
            },
            filterReset: function(){
                this.searchString = null
            },
            computeFilter: function(string){
                switch(string) {
                    case null:
                        return null;
                        break;
                    case 'notFree':
                        return function(item){
                            return item.price > 0;
                        };
                        break;
                    case 'free':
                        return function(item){
                            return item.price == 0;
                        };
                        break;
                    default:
                        return null;
                        break;
                }

            },
            addOrder: function (e, detail) {

                var order = detail;
                var indexOf = this.orders.indexOf(order);

                if (indexOf < 0) {
                    order.ordered = 1;
                    order.priceTotal = parseFloat(order.price).toFixed(2);
                    this.push('orders', order);
                } else {
                    var item = this.orders[indexOf];
                    this.set('orders.' + indexOf + '.ordered', item.ordered + 1);
                    var sum = parseFloat(item.priceTotal);
                    sum+=parseFloat(item.price);
                    this.set('orders.' + indexOf + '.priceTotal', sum.toFixed(2));
                }
                this.fire('iron-signal', {name: "up-order", data: order});
            },
            add: function (e) {
                var model = e.model;
                var indexOf = this.orders.indexOf(model.item);
                var item = this.orders[indexOf];
                this.set('orders.' + indexOf + '.ordered', item.ordered + 1);
                var sum = parseFloat(model.item.priceTotal);
                sum+=parseFloat(model.item.price);
                this.set('orders.' + indexOf + '.priceTotal', sum.toFixed(2));
                this.fire('iron-signal', {name: "up-order", data: item});
            },
            remove: function (e) {
                var model = e.model;
                model.set('item.ordered', model.item.ordered - 1);
                var sum = parseFloat(model.item.priceTotal);
                sum-=parseFloat(model.item.price);
                model.set('item.priceTotal', sum.toFixed(2));

                if (model.item.ordered == 0) {
                    var indexOf = this.orders.indexOf(model.item);
                    this.splice('orders', indexOf, 1);
                }
                this.fire('iron-signal', {name: "remove-order", data: model.item});
            },
            resetCart: function(e, detail){
                if(detail.resetCart == true){
                    this.orders = [];
                }
            }
        });
    </script>
</dom-module>
